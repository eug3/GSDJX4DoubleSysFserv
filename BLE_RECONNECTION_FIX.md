# BLE 设备重启后按键通知恢复修复

## 问题描述

当在 EPD 阅读页面时，设备（ESP32-C3）重置后开启蓝牙，手机会重新连接到设备，但手机无法接收到设备的按键通知（BLE notifications）。

## 根本原因

设备重启后，BLE 特征可能需要时间才能完全初始化。在 `SetupDisconnectionHandler()` 中的自动重连流程中，订阅通知前没有给予设备足够的初始化时间，导致通知订阅失败但未进行重试。

## 修复方案

### 1. **为 `SubscribeToNotificationsAsync()` 添加重试机制**

```csharp
// 重试机制：最多尝试 3 次，每次间隔 500ms
// 处理设备重启后特征可能还未就绪的情况
```

- 最多尝试 3 次订阅通知
- 每次重试间隔 500ms
- 如果找不到通知特征，继续重试而不是直接失败
- 添加错误处理，记录订阅流错误

### 2. **为 `CacheWriteCharacteristicAsync()` 添加重试机制**

- 最多尝试 3 次获取可写特征
- 每次重试间隔 500ms
- 更好的日志记录和错误追踪

### 3. **添加关键初始化延迟**

**正常连接时** (在 `ConnectAsync()`)：
- 连接成功后延迟 500ms，再开始获取特征

**自动重连时** (在 `SetupDisconnectionHandler()`)：
- 重连成功后延迟 1000ms，再开始获取特征
- 给设备更多时间来初始化所有特征

**后台重连时** (在 `OnPeripheralConnectedInBackground()`)：
- 后台连接事件收到后延迟 1500ms
- 最长的延迟，因为后台唤醒涉及更多系统开销

## 修改的文件

- `Services/ShinyBleService.cs`：
  - `SubscribeToNotificationsAsync()` - 添加重试机制
  - `CacheWriteCharacteristicAsync()` - 添加重试机制
  - `ConnectAsync()` - 添加初始化延迟
  - `SetupDisconnectionHandler()` - 添加重连延迟
  - `OnPeripheralConnectedInBackground()` - 添加后台连接延迟

## 延迟时间设置原理

| 场景 | 延迟时间 | 原因 |
|------|---------|------|
| 正常连接后初始化 | 500ms | 标准连接，特征快速就绪 |
| 自动重连后初始化 | 1000ms | 连接状态变化监听需要额外时间 |
| 后台重连后初始化 | 1500ms | 后台唤醒和系统恢复需要更多时间 |
| 重试间隔 | 500ms | 给设备处理时间，避免过快重复查询 |

## 测试建议

1. **测试正常连接流程**：
   - 打开应用
   - 扫描并连接到设备
   - 验证按键通知是否正常工作

2. **测试设备重启恢复**：
   - 在 EPD 阅读页面
   - 重启 ESP32 设备
   - 观察手机是否自动重连
   - 重连后验证按键通知是否可用

3. **测试后台重连**：
   - 在 EPD 阅读页面
   - 将应用切换到后台
   - 重启 ESP32 设备
   - 将应用切换到前台
   - 验证是否已自动重连并可接收按键

4. **日志分析**：
   - 查看 "BLE: 通知订阅重试" 日志
   - 确认重试次数和结果
   - 如果看到 "✅ 已订阅通知"，表示成功

## 性能影响

- **正常连接时**：多 500ms 的初始化时间
- **自动重连时**：多 1000ms 的重连时间
- **后台重连时**：多 1500ms 的初始化时间

这些延迟是必要的，用于确保设备特征完全就绪，避免通知订阅失败。

## 后续可能的优化

1. 可以根据实际测试结果调整延迟时间
2. 可以添加设备就绪状态检查，而不是固定延迟
3. 可以在通知流建立后添加心跳检测，确保连接活跃
