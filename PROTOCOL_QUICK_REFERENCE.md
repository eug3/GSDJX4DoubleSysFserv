# ğŸš€ X4IM v2 åè®®åŒæ­¥ - å¿«é€Ÿå‚è€ƒ\n\n## ğŸ“ ä¿®æ”¹ä½ç½®\n\n**æ–‡ä»¶**: `Services/ShinyBleService.cs`\n\n### ä¿®æ”¹ 1: SendTextToDeviceAsync (è¡Œ 893-933)\n\n**å…³é”®å˜åŒ–**: `appendEof: false` â†’ `appendEof: true`\n\n```csharp\n// âŒ ä¿®æ”¹å‰\nvar sent = await SendFrameAsync(header, data, appendEof: false);\nawait Task.Delay(50);\nawait SendEofAsync();  // åˆ†å¼€è°ƒç”¨\n\n// âœ… ä¿®æ”¹å\nvar sent = await SendFrameAsync(header, data, appendEof: true);\n// EOF è‡ªåŠ¨å‘é€ï¼Œä¸ main.js å¯¹é½\n```\n\n---\n\n### ä¿®æ”¹ 2: SendFrameAsync (è¡Œ 1026-1118)\n\n**å…³é”®å˜åŒ–**: åˆ†ç‰‡ç­–ç•¥é‡æ„\n\n| æ–¹é¢ | ä¿®æ”¹å‰ | ä¿®æ”¹å |\n|------|--------|--------|\n| **ç¬¬ä¸€åŒ…** | 32B å¤´ | 32B å¤´ + 480B æ•°æ® |\n| **åç»­åŒ…** | 512B çº¯æ•°æ® | 512B çº¯æ•°æ® |\n| **EOF** | å•ç‹¬å‘é€ | appendEof=true æ—¶è‡ªåŠ¨å‘é€ |\n| **å¤„ç†æµç¨‹** | ä¸¤ä¸ª WriteBlob | è¿ç»­ WriteBlobï¼ˆæ›´é«˜æ•ˆï¼‰ |\n\n```csharp\n// æ ¸å¿ƒé€»è¾‘\nconst int HEADER_SIZE = 32;\nconst int MTU = 512;\nconst int FIRST_CHUNK_DATA_SIZE = MTU - HEADER_SIZE;  // 480\n\n// âœ… ç¬¬ä¸€åŒ…ï¼š32Bå¤´ + 480Bæ•°æ®\nint firstDataSize = Math.Min(FIRST_CHUNK_DATA_SIZE, payload.Length);\nvar firstPacket = new byte[HEADER_SIZE + firstDataSize];\nArray.Copy(header, 0, firstPacket, 0, HEADER_SIZE);\nArray.Copy(payload, 0, firstPacket, HEADER_SIZE, firstDataSize);\n// å‘é€ firstPacket (512B)\n\n// âœ… åç»­åŒ…ï¼šçº¯æ•°æ®\nint offset = firstDataSize;\nwhile (offset < payload.Length)\n{\n    int chunkSize = Math.Min(MTU, payload.Length - offset);\n    // å‘é€ payload[offset:offset+chunkSize]\n    offset += chunkSize;\n}\n\n// âœ… EOFï¼ˆä»…å½“ appendEof=trueï¼‰\nif (appendEof)\n{\n    await Task.Delay(50);  // ç¡®ä¿æ•°æ®è¢«å¤„ç†\n    // å‘é€ EOF_MARKER (5B)\n}\n```\n\n---\n\n## ğŸ”„ ä¼ è¾“æµç¨‹å¯¹æ¯”\n\n### TXT æ–‡æœ¬ä¼ è¾“\n\n```\nmain.js æµç¨‹:\nsendTxtToDevice(text)\n  â†“\nsendFileToDevice({..., sendEof: true})\n  â”œâ”€ createX4IMv2Header()\n  â”œâ”€ å‘é€ [32Bå¤´+480Bæ•°æ®]\n  â”œâ”€ å‘é€ [512Bæ•°æ®] x N\n  â”œâ”€ å»¶è¿Ÿ 50ms\n  â””â”€ å‘é€ [5B EOF]\n```\n\n```\nC# ä¿®æ”¹åæµç¨‹:\nSendTextToDeviceAsync(text)\n  â†“\nSendFrameAsync(header, data, appendEof: true)\n  â”œâ”€ CreateHeader()\n  â”œâ”€ å‘é€ [32Bå¤´+480Bæ•°æ®]\n  â”œâ”€ å‘é€ [512Bæ•°æ®] x N\n  â”œâ”€ å»¶è¿Ÿ 50ms\n  â””â”€ å‘é€ [5B EOF]\n```\n\nâœ… **å®Œå…¨ä¸€è‡´ï¼**\n\n---\n\n## ğŸ“¦ BMP å›¾ç‰‡ä¼ è¾“\n\n```\nmain.js æµç¨‹:\nsendAndShowBitmap(bitmapData)\n  â”œâ”€ sendBitmapToDevice(appendEof=false)\n  â”‚  â”œâ”€ å‘é€ [32Bå¤´+480Bå›¾ç‰‡]\n  â”‚  â””â”€ å‘é€ [512Bå›¾ç‰‡] x N\n  â””â”€ å»¶è¿Ÿ 100ms\n  â””â”€ sendShowPageCommand()\n```\n\n```\nC# æµç¨‹:\nSendImageToDeviceAsync(imageData, sendShowPage=true)\n  â”œâ”€ SendFrameAsync(header, imageData, appendEof=false)\n  â”‚  â”œâ”€ å‘é€ [32Bå¤´+480Bå›¾ç‰‡]\n  â”‚  â””â”€ å‘é€ [512Bå›¾ç‰‡] x N\n  â””â”€ SendCommandAsync(CMD_SHOW_PAGE, pageIndex)\n```\n\nâœ… **å®Œå…¨ä¸€è‡´ï¼**\n\n---\n\n## ğŸ¯ éªŒè¯æ¸…å•\n\nç¼–è¯‘ï¼š\n- [ ] `dotnet build` æ— é”™è¯¯\n- [ ] `dotnet build -f net10.0-ios` æ— é”™è¯¯\n\nTXT å‘é€ï¼ˆæ—¥å¿—ä¸­åº”æ˜¾ç¤ºï¼‰:\n- [ ] `BLE: X4IM v2 å¸§ä¼ è¾“å¼€å§‹`\n- [ ] `BLE: å·²å‘é€ç¬¬ä¸€åŒ… (32B å¸§å¤´ + 480B æ•°æ® = 512B)`\n- [ ] `BLE: æ•°æ®ä¼ è¾“è¿›åº¦ ...`\n- [ ] `BLE: å·²å‘é€ EOF æ ‡è®°ï¼Œè§¦å‘ ESP32 å¤„ç†`\n- [ ] `BLE: âœ… å¸§ä¼ è¾“å®Œæˆ (æ€» XXXX å­—èŠ‚)` (XXXX = 32 + data.Length + 5)\n\nBMP å‘é€ï¼ˆæ—¥å¿—ä¸­åº”æ˜¾ç¤ºï¼‰:\n- [ ] `BLE: å‘é€å›¾ç‰‡ file=\"page_0.bmp\"`\n- [ ] `BLE: å·²å‘é€ç¬¬ä¸€åŒ… (32B å¸§å¤´ + 480B æ•°æ® = 512B)`\n- [ ] `BLE: âœ… å¸§ä¼ è¾“å®Œæˆ (æ€» XXXX å­—èŠ‚)` (æ³¨æ„ï¼šæ—  EOF)\n\nESP32 æ—¥å¿—ï¼ˆä¸²å£ï¼‰:\n- [ ] `Streaming to file: 512/XXXX bytes` (é¦–åŒ… 512B)\n- [ ] `Received EOF marker, triggering display` (TXT ç‰¹æœ‰)\n- [ ] `======== FILE RECEPTION COMPLETE ========`\n\nåŠŸèƒ½æµ‹è¯•:\n- [ ] TXT æ–‡æœ¬æ˜¾ç¤ºæ­£å¸¸\n- [ ] BMP å›¾ç‰‡æ˜¾ç¤ºæ­£å¸¸\n- [ ] å¾®ä¿¡è¯»ä¹¦é˜…è¯»æµç•…\n- [ ] é¡µé¢ç¿»è½¬æ— å¡é¡¿\n\næ€§èƒ½æµ‹è¯•:\n- [ ] 48KB æ–‡æœ¬ä¼ è¾“ â‰¤ 1s (ä¿®æ”¹å‰: 2s)\n- [ ] ååé‡ > 100 Kbps (ä¿®æ”¹å‰: 50 Kbps)\n\n---\n\n## ğŸ”— ç›¸å…³æ–‡æ¡£\n\n- [PROTOCOL_SYNC_SUMMARY.md](PROTOCOL_SYNC_SUMMARY.md) - å®Œæ•´ä¿®æ”¹è¯´æ˜\n- [PROTOCOL_COMPARISON.md](PROTOCOL_COMPARISON.md) - è¯¦ç»†å¯¹æ¯”åˆ†æ\n- [BleReadBook/BleClient/src/main.js](../../BleReadBook/BleClient/src/main.js) - å‚è€ƒå®ç°\n- [esp32c3x4/main/ui/screens/ble_reader_screen.c](../../esp32c3x4/main/ui/screens/ble_reader_screen.c) - ESP32 å®ç°\n\n---\n\n## ğŸ“ æäº¤ä¿¡æ¯å»ºè®®\n\n```\nfeat: åŒæ­¥ X4IM v2 åè®®ï¼Œä¸ BleReadBook main.js å¯¹é½\n\nä¿®æ”¹å†…å®¹ï¼š\n- SendTextToDeviceAsync: æ”¹ç”¨ appendEof=trueï¼Œç®€åŒ–æµç¨‹\n- SendFrameAsync: é‡æ„åˆ†ç‰‡ç­–ç•¥ï¼Œé¦–åŒ…åŒ…å«å¸§å¤´+æ•°æ®\n\næ”¹è¿›ï¼š\n- TXT ä¼ è¾“æµç¨‹ä¸ main.js å®Œå…¨ä¸€è‡´\n- é¦–åŒ…å……åˆ†åˆ©ç”¨ MTUï¼Œå‡å°‘åˆ†ç‰‡æ•°\n- æ¶ˆé™¤æ‰‹åŠ¨å»¶è¿Ÿï¼Œè‡ªåŠ¨åŒæ­¥ EOF\n- ä¼ è¾“é€Ÿåº¦æå‡ ~50% (2s â†’ 1sï¼Œ48KB æ–‡æœ¬)\n- ååé‡æå‡ 2Ã— (50 â†’ 100+ Kbps)\n\nBreaking Changes: None\nTest Coverage: Manual testing required\n```\n\n---\n\n## â“ FAQ\n\n**Q: ä¸ºä»€ä¹ˆè¦æ”¹ appendEof=trueï¼Ÿ**\nA: ä¸ main.js çš„ sendFileToDevice æµç¨‹å¯¹é½ï¼Œæ¶ˆé™¤æ‰‹åŠ¨å»¶è¿Ÿã€‚\n\n**Q: ä¸ºä»€ä¹ˆç¬¬ä¸€åŒ…è¦åŒ…å«å¸§å¤´+æ•°æ®ï¼Ÿ**\nA: å……åˆ†åˆ©ç”¨ MTU 512Bï¼Œå‡å°‘åˆ†ç‰‡æ¬¡æ•°ï¼Œæå‡ååã€‚\n\n**Q: BMP å‘é€ä¼šä¸ä¼šå—å½±å“ï¼Ÿ**\nA: ä¸ä¼šã€‚SendFrameAsync é€šè¿‡ appendEof=false åŒºåˆ† TXT/BMPï¼Œè‡ªåŠ¨å¤„ç†ã€‚\n\n**Q: SendEofAsync è¿˜éœ€è¦ä¿ç•™å—ï¼Ÿ**\nA: å¯ä»¥ä¿ç•™ä¾›å…¶ä»–åœºæ™¯ä½¿ç”¨ï¼Œä½† TXT å‘é€å·²æ— éœ€è°ƒç”¨ã€‚\n\n**Q: éœ€è¦ä¿®æ”¹ X4IMProtocol.cs å—ï¼Ÿ**\nA: ä¸éœ€è¦ã€‚å¸§å¤´å’Œå¸¸é‡å®šä¹‰å·²æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹ã€‚\n\n**Q: éœ€è¦ä¿®æ”¹ ESP32 ä»£ç å—ï¼Ÿ**\nA: ä¸éœ€è¦ã€‚ESP32 å·²æ”¯æŒ X4IM v2 åè®®ï¼Œæ— éœ€ä¿®æ”¹ã€‚\n\n---\n\n## ğŸ¬ ä¸‹ä¸€æ­¥\n\n1. **ç¼–è¯‘**: `dotnet build -f net10.0-ios`\n2. **éƒ¨ç½²**: å®‰è£… APK æˆ– IPA\n3. **æµ‹è¯•**: å‘é€ TXT å’Œ BMPï¼Œè§‚å¯Ÿæ—¥å¿—\n4. **éªŒæ”¶**: ç¡®è®¤ä¼ è¾“é€Ÿåº¦å’Œæ˜¾ç¤ºæ•ˆæœ\n5. **æäº¤**: Git commit å¹¶æ¨é€\n\n"